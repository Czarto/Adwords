var MAX_INCREASE = 0.1
var MAX_MIN_LEVEL = 0.9
var CONVERSION_THRESHOLD = 20;
var CONVERSION_VALUE = 30;

function main() { 
  //setAdGroupBids("ALL_TIME");
  
  setLocationBids("LAST_30_DAYS");
  setAdScheduleBids("LAST_30_DAYS");
  setMobileBidModifier("LAST_30_DAYS");
}


function setLocationBids(dateRange) {
 
  var campaignIterator = AdWordsApp.campaigns()
      .forDateRange(dateRange)
      .withCondition("Status = ENABLED")
      .withCondition("LabelNames CONTAINS_NONE ['Script Ignore']")
      .get();
  
  Logger.log(' ')
  Logger.log('### ADJUST LOCATION TARGETING BIDS ###');
  Logger.log('Total Campaigns found : ' + campaignIterator.totalNumEntities());
  
  while (campaignIterator.hasNext()) {
    var campaign = campaignIterator.next();
    var stats = campaign.getStatsFor(dateRange);
    var campaignConvRate = stats.getClickConversionRate();
    
    Logger.log(' ');
    Logger.log('CAMPAIGN: ' + campaign.getName());
    
    var locationIterator = campaign.targeting().targetedLocations().get();

    while (locationIterator.hasNext()) {
      var targetedLocation = locationIterator.next();
      
      if( targetedLocation.getTargetType() != "Country" ) {

        var locationStats = targetedLocation.getStatsFor(dateRange);
        var locationConvRate = locationStats.getConversionRate();
        var locationConversions = locationStats.getConversions();
        var locationCost = locationStats.getCost();
        var calculatedBidAdjustment = locationConvRate / campaignConvRate;
        var oldBidModifier = targetedLocation.getBidModifier();
        var locationName = targetedLocation.getName();
        var locationCountryCode = targetedLocation.getCountryCode();        

        if( locationConversions > 0 ) {
        
          // Conversion rate MORE than average, but current bid is negative. Increase by 10%.      
          if( locationConvRate > campaignConvRate && oldBidModifier < MAX_MIN_LEVEL ) {
            if( calculatedBidAdjustment > (oldBidModifier + MAX_INCREASE) ) {
              var newBidModifier = oldBidModifier + MAX_INCREASE;
              targetedLocation.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE *** Location name: ' + locationName
                   + ', bid modifier: ' + newBidModifier
                   + ', Better than average conversion rate, but negative bidding. Increase bid.');
            
            }
            
          // Conversion rate LESS than the average. Drop bids by 10%.
          } else if (locationConvRate < campaignConvRate) {
            if( calculatedBidAdjustment < (oldBidModifier - MAX_INCREASE) ) {
              var newBidModifier = Math.max(Math.min(oldBidModifier - MAX_INCREASE, 0.9),0.1);
              targetedLocation.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE *** Location name: ' + locationName 
                   + ', bid modifier: ' + newBidModifier
                   + ' Bad CPA, decrease bids');            
            }          
          }
        
          // Many Conversions. Increase bids by 10%.
          if( locationConversions > CONVERSION_THRESHOLD ) {
            if( calculatedBidAdjustment > (oldBidModifier + MAX_INCREASE) ) {
              var newBidModifier = oldBidModifier + MAX_INCREASE;
              targetedLocation.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE *** Location name: ' + locationName 
                   + ', bid modifier: ' + newBidModifier
                   + ' Good CPA, increase bids');            
            } 
          }
        }
        
        // Zero Conversions, Hight Cost. Drop bids by 10%.
        if( locationConversions == 0 && locationCost > CONVERSION_VALUE  ) { 
              var newBidModifier = Math.max(Math.min(oldBidModifier - MAX_INCREASE, 0.9),0.1);
              targetedLocation.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE *** Location name: ' + locationName 
                   + ', bid modifier: ' + newBidModifier
                   + ' zero conversions & high cost');
        }        
      }
    }
  }   
}


function setAdScheduleBids(dateRange) {
 
  var campaignIterator = AdWordsApp.campaigns()
      .forDateRange(dateRange)
      .withCondition("Status = ENABLED")
      .withCondition("LabelNames CONTAINS_NONE ['Script Ignore']")
      .get();
  
  Logger.log(' ')
  Logger.log('### ADJUST AD SCHEDULE TARGETING BIDS ###');
  Logger.log('Total Campaigns found : ' + campaignIterator.totalNumEntities());
  
  while (campaignIterator.hasNext()) {
    var campaign = campaignIterator.next();
    var stats = campaign.getStatsFor(dateRange);
    var campaignConvRate = stats.getClickConversionRate();
    
    Logger.log(' ');
    Logger.log('CAMPAIGN: ' + campaign.getName());
    
    var adScheduleIterator = campaign.targeting().adSchedules().get();

    while (adScheduleIterator.hasNext()) {
      var adSchedule = adScheduleIterator.next();
      
        var adScheduleStats = adSchedule.getStatsFor(dateRange);
        var adScheduleConvRate = adScheduleStats.getConversionRate();
        var adScheduleConversions = adScheduleStats.getConversions();
        var adScheduleCost = adScheduleStats.getCost();
        var calculatedBidAdjustment = adScheduleConvRate / campaignConvRate;
        var oldBidModifier = adSchedule.getBidModifier();
        var adScheduleName = adSchedule.getDayOfWeek() + ' @ ' + adSchedule.getStartHour();
        

        if( adScheduleConversions > 0 ) {
        
          // Conversion rate MORE than average, but current bid is negative. Increase by 10%.      
          if( adScheduleConvRate > campaignConvRate && oldBidModifier < MAX_MIN_LEVEL ) {
            if( calculatedBidAdjustment > (oldBidModifier + MAX_INCREASE) ) {
              var newBidModifier = oldBidModifier + MAX_INCREASE;
              adSchedule.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE: Ad Schedule: ' + adScheduleName 
                   + '; increase bid: from ' + oldBidModifier + ' to ' + newBidModifier
                   + ' high conversion rate');            
            }
            
          // Conversion rate LESS than the average. Drop bids by 10%.
          } else if (adScheduleConvRate < campaignConvRate) {
            if( calculatedBidAdjustment < (oldBidModifier - MAX_INCREASE) ) {
              var newBidModifier = Math.max(Math.min(oldBidModifier - MAX_INCREASE, 0.9),0.1);
              adSchedule.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE: Ad Schedule: ' + adScheduleName 
                   + '; lower bid: from ' + oldBidModifier + ' to ' + newBidModifier
                   + ' low conversion rate');           
            }          
          }
        
          // Many Conversions. Increase bids by 10%.
          if( adScheduleConversions > CONVERSION_THRESHOLD ) {
            if( calculatedBidAdjustment > (oldBidModifier + MAX_INCREASE) ) {
              var newBidModifier = oldBidModifier + MAX_INCREASE;
              adSchedule.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE: Ad Schedule: ' + adScheduleName 
                   + '; increase bid: from ' + oldBidModifier + ' to ' + newBidModifier
                   + ' Many Conversions, Good CPA');               
            } 
          }
        }
        
        // Zero Conversions, Hight Cost. Drop bids by 10%.
        if( adScheduleConversions == 0 && adScheduleCost > CONVERSION_VALUE  ) { 
              var newBidModifier = Math.max(Math.min(oldBidModifier - MAX_INCREASE, 0.9),0.1);
              adSchedule.setBidModifier(newBidModifier);           
              Logger.log('*** UPDATE: Ad Schedule: ' + adScheduleName 
                   + '; lower bid: from ' + oldBidModifier + ' to ' + newBidModifier
                   + ' Zero conversions, high cost');    
        }        
      }
  }   
}


// Mobile Bids
function setMobileBidModifier(dateRange) {

  var campaignIterator = AdWordsApp.campaigns()
      .forDateRange(dateRange)
      .withCondition("Status = ENABLED")
      .withCondition("LabelNames CONTAINS_NONE ['Script Ignore']")
      .get();
  
  Logger.log(' ')
  Logger.log('### ADJUST MOBILE TARGETING BIDS ###');
  Logger.log('Total Campaigns found : ' + campaignIterator.totalNumEntities());
  
  while (campaignIterator.hasNext()) {
    var campaign = campaignIterator.next();
    var stats = campaign.getStatsFor(dateRange);
    var campaignConvRate = stats.getClickConversionRate();
    
    Logger.log(' ');
    Logger.log('CAMPAIGN: ' + campaign.getName());
    
    var desktopTargetIterator = campaign.targeting().platforms().desktop().get();
    var tabletTargetIterator = campaign.targeting().platforms().tablet().get();
    var mobileTargetIterator = campaign.targeting().platforms().mobile().get();
      
    if( desktopTargetIterator.hasNext()) {
      var desktopTarget = desktopTargetIterator.next();
      var desktopStats = desktopTarget.getStatsFor(dateRange);
      var desktopConversionRate = desktopStats.getConversionRate();
    
      if( tabletTargetIterator.hasNext()) {
        var tabletTarget = tabletTargetIterator.next();
        var tabletStats = tabletTarget.getStatsFor(dateRange);
        var tabletConversionRate = tabletStats.getConversionRate();
        var tabletNewBidAdjustment = tabletConversionRate / desktopConversionRate;
        var tabletOldBidAdjustment = tabletTarget.getBidModifier();
             
        if( tabletConversionRate > desktopConversionRate && tabletOldBidAdjustment < MAX_MIN_LEVEL ) {
          if( tabletNewBidAdjustment > (tabletOldBidAdjustment + MAX_INCREASE) ) {
            var newBidModifier = tabletOldBidAdjustment + MAX_INCREASE;
            tabletTarget.setBidModifier(newBidModifier);           
            Logger.log('*** UPDATE: Tablet Bid Modifer; '
                 + 'Increase bid: from ' + tabletOldBidAdjustment + ' to ' + newBidModifier);            
          }
        } else if (tabletConversionRate < desktopConversionRate) {
          if( tabletNewBidAdjustment < (tabletOldBidAdjustment - MAX_INCREASE) ) {
            var newBidModifier = Math.max(Math.min(tabletOldBidAdjustment - MAX_INCREASE, 0.9),0.1);
            tabletTarget.setBidModifier(newBidModifier);           
            Logger.log('*** UPDATE: Tablet Bid Modifer; '
                 + 'Lower bid: from ' + tabletOldBidAdjustment + ' to ' + newBidModifier);               
          }          
        }
      }
      
      if( mobileTargetIterator.hasNext()) {
        var mobileTarget = mobileTargetIterator.next();
        var mobileStats = mobileTarget.getStatsFor(dateRange);
        var mobileConversionRate = mobileStats.getConversionRate();
        var mobileNewBidAdjustment = mobileConversionRate / desktopConversionRate;
        var mobileOldBidAdjustment = mobileTarget.getBidModifier();
                
        if( mobileConversionRate > desktopConversionRate && mobileOldBidAdjustment < MAX_MIN_LEVEL ) {
          if( mobileNewBidAdjustment > (mobileOldBidAdjustment + MAX_INCREASE) ) {
            var newBidModifier = mobileOldBidAdjustment + MAX_INCREASE;
            mobileTarget.setBidModifier(newBidModifier);           
            Logger.log('*** UPDATE: Mobile Bid Modifer; '
                 + 'Increase bid: from ' + mobileOldBidAdjustment + ' to ' + newBidModifier);            
          }
        } else if (mobileConversionRate < desktopConversionRate) {
          if( mobileNewBidAdjustment < (mobileOldBidAdjustment - MAX_INCREASE) ) {
            var newBidModifier = Math.max(Math.min(mobileOldBidAdjustment - MAX_INCREASE, 0.9),0.1);
            mobileTarget.setBidModifier(newBidModifier);           
            Logger.log('*** UPDATE: Mobile Bid Modifer; '
                 + 'Lower bid: from ' + mobileOldBidAdjustment + ' to ' + newBidModifier);               
          }          
        }
      }
    }
  }
}


function formatSchedule(schedule) {
  function zeroPad(number) { return Utilities.formatString('%02d', number); }
  return schedule.getDayOfWeek() + ', ' +
      schedule.getStartHour() + ':' + zeroPad(schedule.getStartMinute()) +
      ' to ' + schedule.getEndHour() + ':' + zeroPad(schedule.getEndMinute());
}

